<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="mb-marker-content.html">

<link rel="import" href="key-storage.html">

<dom-module id="mb-map-page">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
        position: relative;
        width: 100%;
        z-index: 0;
      }

      @media(min-width: 767px) {
        :host {
          height: 100%;
          margin-left: 360px;
        }
      }

      @media(min-width: 1280px) {
        :host {
          margin-left: 400px;
        }
      }

      #googleMap {
        height: 100%;
        width: 100%;
      }

      paper-spinner-lite {
        --paper-spinner-color: var(--mb-primary-color);
        position: absolute;
        right: 26px;
        top: 19px;
        z-index: 2;
      }

      @media(max-width: 767px) {
        mb-search {
          left: 0;
          padding: 10px;
          position: absolute;
          right: 0;
          top: 0;
          z-index: 1;
        }
      }

      @media(min-width: 767px) {
        mb-search {
          left: 20px;
          position: absolute;
          top: 20px;
          width: 400px;
          z-index: 1;
        }
      }

    </style>

    <key-storage
      google-api="{{_gApiKey}}"></key-storage>

    <paper-spinner-lite active="[[loading]]"></paper-spinner-lite>

    <mb-search
      search-value="{{searchValue}}"
      blogs="[[blogs]]"
      partners="[[partners]]"
      places="[[mapSearchResults]]"></mb-search>

    <google-map-search
        global-search
        map="[[map]]"
        query="[[searchValue]]"
        results="{{mapSearchResults}}"></google-map-search>

    <google-map
        id="googleMap"
        api-key="[[_gApiKey]]"
        map="{{map}}"
        draggable="true"
        zoom="{{zoom}}"
        latitude="{{latitude}}"
        longitude="{{longitude}}"
        styles="[[mapStyles]]"
        disable-default-ui
        additional-map-options="[[additionalMapOptions]]"
        disable-map-type-control>

      <template is="dom-repeat" items="[[_returnWhenLoadComplete(blogs, loadComplete)]]">
        <google-map-marker
            open="[[_isEqual(blog.id, item.id)]]"
            latitude="[[item.lat]]"
            longitude="[[item.lng]]"
            title="[[item.title]]"
            icon="/images/blog-marker.png"
            click-events>
          <mb-marker-content type="blog" item-id$="[[item.id]]">
            <iron-image src$="[[item.images.0]]" sizing="cover"></iron-image>
            <h3>[[item.title]]</h3>
          </mb-marker-content>
        </google-map-marker>
      </template>

      <template is="dom-repeat" items="[[_returnWhenLoadComplete(partners, loadComplete)]]">
        <google-map-marker
            open="[[_isEqual(partner.id, item.id)]]"
            latitude="[[item.lat]]"
            longitude="[[item.lng]]"
            title="[[item.title]]"
            icon="/images/partner-marker.png"
            click-events>
          <mb-marker-content type="partner" item-id$="[[item.id]]">
            <iron-image src$="[[item.images.0]]" sizing="cover"></iron-image>
            <h3>[[item.title]]</h3>
          </mb-marker-content>
        </google-map-marker>
      </template>

    </google-map>

    <template is="dom-if" if="[[smallScreen]]">
      <mb-map-panel
          blogs="[[blogs]]"
          partners="[[partners]]"
          latitude="[[latitude]]"
          longitude="[[longitude]]"
          loading-current-position="[[_loadingCurrentPosition]]"></mb-map-panel>
    </template>

  </template>
  <script>

    Polymer({

      is: 'mb-map-page',

      properties: {

        /**
         * Standarized string with the latitude, longitude and zoom.
         * It uses the same format as google.com/maps
         *
         * e.g. @40.4669538,-3.6793216,15z
         *
         */
        mapView: {
          type: String,
          observer: '_mapViewChanged'
        },

        latitude: {
          type: Number,
          value: 23.59
        },

        longitude: {
          type: Number,
          value: 119.89
        },

        zoom: {
          type: Number,
          value: 8
        },

        map: Object,

        partner: {
          type: Object,
          observer: '_partnerChanged'
        },

        partners: Array,

        blog: {
          type: Object,
          observer: '_blogChanged'
        },

        blogs: Array,

        idle: {
          type: Boolean,
          readOnly: true,
          notify: true,
          value: false
        },

        additionalMapOptions: {
          type: Object,
          value: function() {
            return {};
          }
        },

        // Generated by https://mapstyle.withgoogle.com/
        mapStyles: {
          type: Array,
          value: function() {
            return [
              {
                "featureType": "administrative.land_parcel",
                "elementType": "labels",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "poi",
                "elementType": "labels.text",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "road.local",
                "elementType": "labels",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              }
            ];
          }
        },

        loading: {
          type: Boolean,
          readOnly: true,
          computed: '_computedLoading(_loadingCurrentPosition)',
          notify: true
        },

        visible: Boolean,

        loadComplete: Boolean,

        _loadingCurrentPosition: Boolean,

        _fireChangeRouteTimeout: Number

      },

      observers: [
        '_visibleChanged(visible, loadComplete)',
        '_fireChangeRoute(latitude, longitude, zoom)'
      ],

      listeners: {
        'google-map-idle': '_googleMapIdle',
        'google-map-ready': '_googleMapReady',
        'center-current-position': '_centerCurrentPosition'
      },

      _googleMapIdle: function(event) {
        this._setIdle(true);
      },

      _googleMapReady: function() {
        // this._centerCurrentPosition();
      },

      _partnerChanged: function(partner) {
        if (partner) {
          this.latitude = partner.lat;
          this.longitude = partner.lng - 0.20;
          this.zoom = Math.min(10, this.zoom);
        }
      },

      _blogChanged: function(blog) {
        if (blog) {
          this.latitude = blog.lat;
          this.longitude = blog.lng - 0.20;
          this.zoom = Math.min(10, this.zoom);
        }
      },

      _visibleChanged: function(visible, loadComplete) {
        if (visible && loadComplete) {
          // Fix to grey/white map.
          // https://github.com/GoogleWebComponents/google-map/issues/350
          this.$.googleMap.$.map.style.position = 'absolute';
          this.$.googleMap.resize();
        }
      },

      _centerCurrentPosition: function() {
        if (navigator.geolocation) {
          this._loadingCurrentPosition = true;

          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            this._loadingCurrentPosition = false;
            this.map.setCenter(pos);
            this.zoom = 15;
          }.bind(this), function() {
            this._loadingCurrentPosition = false;
            this._displayGeolocationFailSnackbar();
          }.bind(this));
        } else {
          this._displayGeolocationFailSnackbar();
        }
      },

      /**
       * Closes the page by returning to;
       */
      _closeTapped: function() {
        this.fire('change-route', {page: 'list'});
      },

      _fireChangeRoute: function(latitude, longitude, zoom) {
        this._setIdle(false);
        clearTimeout(this._fireChangeRouteTimeout);

        this._fireChangeRouteTimeout = setTimeout(function() {
          var url = '@' + latitude.toFixed(5) + ',' + longitude.toFixed(5) + ',' + zoom + 'z';
          this.fire('change-route', {mapView: url});
        }.bind(this), 100);
      },

      _mapViewChanged: function(mapView) {
        if (mapView) {
          try {
            var params = mapView.match(/@([-\d\.]+),([-\d\.]+),(\d+)z/)
              .splice(1).map(Number);

            this.latitude = params[0];
            this.longitude = params[1];
            this.zoom = params[2];
          } catch(err) {
          }
        } else {
          this._fireChangeRoute(this.zoom, this.latitude, this.longitude);
        }
      },

      _displayGeolocationFailSnackbar: function() {
        console.log('geolocation-failed');
      },

      _computedLoading: function(_loadingCurrentPosition) {
        return _loadingCurrentPosition;
      },

      _isEqual: function(a, b) {
        return a === b;
      },

      _returnWhenLoadComplete: function(value, loadComplete) {
        if (loadComplete) {
          return value;
        }
      }

    });

  </script>
</dom-module>
